<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ - NURSE MST</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/gc78j2ZM/IMG-8784.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { 
            font-family: 'Prompt', sans-serif; 
            background: #f3f0f7; 
            padding-top: 20px; /* ‡∏•‡∏î Padding ‡∏ö‡∏ô‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            padding-bottom: 40px;
        }
        .container {
            padding-left: 15px;
            padding-right: 15px;
        }
        .card { 
            border-radius: 20px; 
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .form-control {
            border-radius: 12px;
            padding: 12px;
            font-size: 16px; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô iOS ‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≠‡∏ô‡∏Å‡∏î input */
        }
        .btn-check-history {
            background: #6A1B9A; 
            color: white;
            border-radius: 12px;
            padding: 12px;
            transition: 0.3s;
        }
        .btn-check-history:hover {
            background: #4a148c;
            color: white;
        }
        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ */
        .history-card {
            border-left: 5px solid #6A1B9A !important;
            transition: transform 0.2s;
        }
        @media (max-width: 576px) {
            body { padding-top: 15px; }
            h5 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>
    <div class="container" style="max-width:500px;">
        <div class="card p-4 mb-4">
            <div class="text-center mb-3">
                <img src="https://i.postimg.cc/gc78j2ZM/IMG-8784.png" width="60" alt="Logo" class="mb-2">
                <h5 class="fw-bold" style="color:#6A1B9A">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h5>
            </div>
            <div class="mb-2">
                <label class="small text-muted mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <input type="number" id="sid" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
            </div>
            <div class="mb-3">
                <label class="small text-muted mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                <input type="tel" id="phone" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
            </div>
            <button onclick="fetchH()" class="btn w-100 fw-bold btn-check-history">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <div class="text-center mt-3"><a href="index.html" class="text-muted small text-decoration-none">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></div>
        </div>

        <div id="res" style="display:none;">
            <div class="d-flex align-items-center justify-content-center mb-3">
                <div style="height:2px; background:#6A1B9A; flex-grow:1;"></div>
                <h6 id="uN" class="fw-bold mx-3 mb-0 text-dark"></h6>
                <div style="height:2px; background:#6A1B9A; flex-grow:1;"></div>
            </div>
            <div id="list"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBY2n_f64ayN0Rlsq2x6-HT4NxmcePVCKA",
            authDomain: "nurse-mstsc.firebaseapp.com",
            projectId: "nurse-mstsc",
            storageBucket: "nurse-mstsc.firebasestorage.app",
            messagingSenderId: "144915684733",
            appId: "1:144915684733:web:159a506c369c02410a4014"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.fetchH = async () => {
            const sid = document.getElementById('sid').value;
            const ph = document.getElementById('phone').value;

            if(!sid || !ph) {
                Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
                return;
            }

            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const sSnap = await getDoc(doc(db, "students", sid));
                if(!sSnap.exists() || sSnap.data().phone !== ph) {
                    Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error');
                    return;
                }

                const q = query(
                    collection(db, "visits"), 
                    where("studentId", "==", sid), 
                    where("status", "==", "Completed"), 
                    orderBy("timestamp", "desc")
                );
                const querySnapshot = await getDocs(q);
                
                Swal.close();
                document.getElementById('res').style.display='block';
                document.getElementById('uN').innerText = sSnap.data().fname + ' ' + sSnap.data().lname;
                
                let html = '';
                querySnapshot.forEach((d) => {
                    const v = d.data();
                    const date = v.timestamp ? new Date(v.timestamp.seconds * 1000).toLocaleString('th-TH', {
                        year: 'numeric', month: 'short', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    }) : '-';
                    
                    html += `
                        <div class="card p-3 mb-3 history-card shadow-sm">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge bg-primary rounded-pill">${v.category}</span>
                                <span class="text-muted" style="font-size: 0.75rem;">${date}</span>
                            </div>
                            <div class="fw-bold mb-1" style="font-size: 0.95rem;">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</div>
                            <div class="text-secondary small mb-2">${v.detail || '-'}</div>
                            <div class="pt-2 border-top">
                                <span class="small fw-bold text-success">üíä ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${v.medicine || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</span>
                            </div>
                        </div>`;
                });
                document.getElementById('list').innerHTML = html || '<div class="card p-4 text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</div>';
                
                // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏•‡∏á‡∏°‡∏≤‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
                document.getElementById('res').scrollIntoView({ behavior: 'smooth' });

            } catch(e) {
                console.error(e);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á', 'error');
            }
        };
    </script>
</body>
</html>
