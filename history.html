<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ประวัติ - Nurse MST</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { font-family: 'Prompt', sans-serif; background: #f3f0f7; padding-top: 50px; } .card { border-radius: 20px; }</style>
</head>
<body>
    <div class="container" style="max-width:500px;">
        <div class="card p-4 mb-4">
            <h5 class="fw-bold text-center mb-4" style="color:#6A1B9A">ตรวจสอบประวัติการรักษา</h5>
            <input type="number" id="sid" class="form-control mb-2" placeholder="รหัสนักเรียน">
            <input type="tel" id="phone" class="form-control mb-3" placeholder="เบอร์โทรศัพท์">
            <button onclick="fetchH()" class="btn w-100 fw-bold" style="background:#6A1B9A; color:white;">ตรวจสอบข้อมูล</button>
            <div class="text-center mt-3"><a href="index.html" class="text-muted small">กลับหน้าหลัก</a></div>
        </div>
        <div id="res" style="display:none;">
            <h6 id="uN" class="fw-bold text-center mb-2"></h6>
            <div id="list"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Config ของคุณ ---
        const firebaseConfig = {
            apiKey: "AIzaSyBY2n_f64ayN0Rlsq2x6-HT4NxmcePVCKA",
            authDomain: "nurse-mstsc.firebaseapp.com",
            projectId: "nurse-mstsc",
            storageBucket: "nurse-mstsc.firebasestorage.app",
            messagingSenderId: "144915684733",
            appId: "1:144915684733:web:159a506c369c02410a4014"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.fetchH = async () => {
            const sid = document.getElementById('sid').value;
            const ph = document.getElementById('phone').value;
            Swal.fire({didOpen:()=>Swal.showLoading()});

            try {
                const sSnap = await getDoc(doc(db, "students", sid));
                if(!sSnap.exists() || sSnap.data().phone !== ph) {
                    Swal.fire('ไม่พบข้อมูล','รหัสหรือเบอร์โทรผิด','error');
                    return;
                }

                const q = query(collection(db, "visits"), where("studentId", "==", sid), where("status", "==", "Completed"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                Swal.close();
                document.getElementById('res').style.display='block';
                document.getElementById('uN').innerText = sSnap.data().fname + ' ' + sSnap.data().lname;
                
                let html = '';
                querySnapshot.forEach((d) => {
                    const v = d.data();
                    const date = v.timestamp ? new Date(v.timestamp.seconds * 1000).toLocaleString('th-TH') : '-';
                    html += `<div class="card p-3 mb-2 shadow-sm border-start border-4 border-primary"><div class="d-flex justify-content-between small fw-bold text-primary"><span>${v.category}</span><span>${date}</span></div><div class="small mt-1">${v.detail}</div><div class="small text-success fw-bold">ยา: ${v.medicine}</div></div>`;
                });
                document.getElementById('list').innerHTML = html || '<p class="text-center text-muted">ไม่มีประวัติ</p>';
            } catch(e) {
                Swal.fire('Error', e.message, 'error');
            }
        };
    </script>
</body>
</html>