<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>NURSE - MST</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/gc78j2ZM/IMG-8784.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #6A1B9A; --secondary: #ffffff; --bg: #f3f0f7; }
        body { 
            font-family: 'Prompt', sans-serif; 
            background: var(--bg); 
            display: flex; 
            align-items: center; 
            min-height: 100vh; 
            justify-content: center; 
            margin: 0;
            padding: 20px;
        }
        
        .main-card { 
            background: white; 
            width: 100%; 
            max-width: 450px; 
            border-radius: 20px; 
            box-shadow: 0 15px 40px rgba(106,27,154,0.15); 
            padding: 50px 25px 30px 25px; 
            position: relative; 
            margin-top: 50px; 
        }

        .logo-badge { 
            width: 90px; height: 90px; 
            background: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            position: absolute; top: -45px; left: 50%; 
            transform: translateX(-50%); 
            border: 4px solid var(--secondary); 
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); 
            z-index: 10;
        }

        .btn-purple { 
            background: var(--primary); color: white; 
            border-radius: 12px; font-weight: 600; 
            padding: 14px; border: none; width: 100%; 
            transition: 0.3s; font-size: 1.1rem;
        }
        .btn-purple:active { transform: scale(0.98); }

        .btn-admin { 
            position: fixed; top: 15px; right: 15px; 
            background: white; color: var(--primary); 
            border: 2px solid var(--primary); border-radius: 30px; 
            padding: 6px 15px; text-decoration: none; 
            font-weight: 600; font-size: 0.75rem; z-index: 1000; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .form-control, .form-select { border-radius: 12px; padding: 12px; }

        @media (max-width: 380px) {
            .main-card { padding: 45px 15px 25px 15px; }
            h3 { font-size: 1.4rem; }
            .logo-badge { width: 80px; height: 80px; top: -40px; }
        }

        .swal2-popup {
            font-family: 'Prompt', sans-serif !important;
            border-radius: 20px !important;
            padding: 1em !important;
            width: 95% !important;
            max-width: 500px !important;
        }
    </style>
</head>
<body>
    <a href="admin.html" class="btn-admin"><i class="fas fa-user-shield me-1"></i> สำหรับเจ้าหน้าที่</a>
    
    <div class="main-card text-center">
        <div class="logo-badge"><img src="https://i.postimg.cc/gc78j2ZM/IMG-8784.png" width="100%"></div>
        <div class="pt-4 mb-4">
            <h3 class="fw-bold" style="color: var(--primary)">ลงทะเบียนเข้ารับบริการ</h3>
            <p class="text-muted small">FAR - MST</p>
        </div>
        <div class="mb-4">
            <input type="tel" id="sid" class="form-control text-center fs-5 fw-bold" maxlength="10" placeholder="กรุณากรอกข้อมูล" inputmode="numeric">
            
            <div class="form-text mt-2 text-muted" style="font-size: 0.85rem;">
                <i class="fas fa-user-graduate me-1"></i>  <b>นักเรียน:</b> ใช้รหัสนักเรียน<br>
                <i class="fas fa-user-tie me-1"></i> <b>ครู/บุคลากร:</b> ใช้รหัสครู/บุคลากร<br>
                <i class="fa-solid fa-user"></i>  <b>บุคคลทั่วไป:</b> ใช้เบอร์โทรศัพท์
            </div>
        </div>
        <button onclick="checkStudent()" class="btn btn-purple shadow">ตรวจสอบข้อมูล / เข้ารับบริการ <i class="fas fa-search ms-2"></i></button>
        <div class="mt-4"><a href="history.html" class="text-decoration-none text-muted small"><i class="fas fa-history me-1"></i> ประวัติการรักษา</a></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBY2n_f64ayN0Rlsq2x6-HT4NxmcePVCKA",
            authDomain: "nurse-mstsc.firebaseapp.com",
            projectId: "nurse-mstsc",
            storageBucket: "nurse-mstsc.firebasestorage.app",
            messagingSenderId: "144915684733",
            appId: "1:144915684733:web:159a506c369c02410a4014"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- เพิ่มฟังก์ชัน Masking สำหรับปิดบังเบอร์โทรศัพท์ ---
        const maskPhone = (phone) => {
            if (!phone || phone.length < 10) return "XXXXXXXXXX";
            // แสดงเฉพาะตัวท้าย 2 ตัว เช่น XXXXXXXXXX07
            return "XXX-XXX-" + phone.substring(6);
        };
        
        window.checkStudent = async () => {
            const sid = document.getElementById('sid').value;
            if(!sid) return Swal.fire('แจ้งเตือน','กรุณากรอกรหัสนักเรียน','warning');
            
            Swal.fire({ title: 'กำลังตรวจสอบ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                const docRef = doc(db, "students", sid);
                const docSnap = await getDoc(docRef);
                Swal.close();

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // บังคับกรอกข้อมูลเพิ่ม หากเบอร์โทรหาย หรือระดับชั้นยังไม่ระบุ
                    if (!data.phone || data.phone.length < 10 || !data.dob || !data.level) {
                        registerForm(sid, data); 
                    } else {
                        confirmVisit(sid, data);
                    }
                } else {
                    registerForm(sid, null);
                }
            } catch(e) {
                Swal.fire('Error', 'การเชื่อมต่อผิดพลาด: ' + e.message, 'error');
            }
        };

        window.registerForm = (sid, oldData) => {
    // 1. เพิ่มตัวเลือกสำหรับบุคคลอื่นที่ไม่ใช่นักเรียน
    let levels = ['ม.1','ม.2','ม.3','ม.4','ม.5','ม.6', 'ครู/บุคลากร', 'บุคคลทั่วไป'];
    
    let rooms = '<option value="-">-</option>'; 
    for(let i=1; i<=15; i++) rooms += `<option value="${i}" ${oldData?.room == i ? 'selected' : ''}>ห้อง ${i}</option>`;
    
    let lOpt = levels.map(l => `<option value="${l}" ${oldData?.level == l ? 'selected':''}>${l}</option>`).join('');
    
    let dOpt = '<option value="">วัน</option>'; for(let i=1; i<=31; i++) dOpt += `<option value="${i}">${i}</option>`;
    let mOpt = '<option value="">เดือน</option>'; ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."].forEach((m,i)=> mOpt+=`<option value="${i+1}">${m}</option>`);
    let yOpt = '<option value="">ปี พ.ศ.</option>'; let cy = new Date().getFullYear()+543; for(let i=cy-5; i>=cy-60; i--) yOpt += `<option value="${i}">${i}</option>`; // ปรับปีให้กว้างขึ้นเผื่อผู้ใหญ่

    Swal.fire({
        title: oldData ? 'แก้ไขข้อมูล' : 'ลงทะเบียนใหม่',
        html: `<div class="text-start p-1" style="font-family:'Prompt'; font-size: 0.9rem;">
            <p class="text-center text-muted mb-3 small">กรุณากรอกข้อมูลให้ครบถ้วน</p>
            <div class="row g-2 mb-2">
                <div class="col-4"><label class="mb-1 small">คำนำหน้า</label>
                    <select id="f1" class="form-select">
                        <option ${oldData?.prefix === 'นาย' ? 'selected' : ''}>นาย</option>
                        <option ${oldData?.prefix === 'นางสาว' ? 'selected' : ''}>นางสาว</option>
                        <option ${oldData?.prefix === 'นาง' ? 'selected' : ''}>นาง</option>
                        <option ${oldData?.prefix === 'ด.ช.' ? 'selected' : ''}>ด.ช.</option>
                        <option ${oldData?.prefix === 'ด.ญ.' ? 'selected' : ''}>ด.ญ.</option>
                    </select>
                </div>
                <div class="col-4"><label class="mb-1 small">ชื่อ</label><input id="f2" class="form-control" value="${oldData?.fname || ''}"></div>
                <div class="col-4"><label class="mb-1 small">สกุล</label><input id="f3" class="form-control" value="${oldData?.lname || ''}"></div>
            </div>
            <div class="row g-2 mb-2">
                <div class="col-6"><label class="mb-1 small text-primary fw-bold">สถานะ/ระดับชั้น</label><select id="f_lvl" class="form-select">${lOpt}</select></div>
                <div class="col-6" id="room-box"><label class="mb-1 small">ห้อง</label><select id="f7" class="form-select">${rooms}</select></div>
                <div class="col-12"><label class="mb-1 small">เลือด</label><select id="f5" class="form-select">
                    <option ${oldData?.blood === 'A' ? 'selected' : ''}>A</option>
                    <option ${oldData?.blood === 'B' ? 'selected' : ''}>B</option>
                    <option ${oldData?.blood === 'O' ? 'selected' : ''}>O</option>
                    <option ${oldData?.blood === 'AB' ? 'selected' : ''}>AB</option>
                    <option ${oldData?.blood === '-' ? 'selected' : ''} value="-">ไม่ทราบ</option>
                 </select></div>
            </div>
            <div class="mb-2">
                 <label class="mb-1 small text-danger">เบอร์โทร (10 หลัก)</label>
                 <input id="f4" class="form-control border-danger" type="tel" maxlength="10" placeholder="08XXXXXXXX" value="${oldData?.phone || ''}">
            </div>
            <label class="mb-1 small">วัน/เดือน/ปีเกิด</label><div class="input-group mb-2"><select id="bd_d" class="form-select">${dOpt}</select><select id="bd_m" class="form-select">${mOpt}</select><select id="bd_y" class="form-select">${yOpt}</select></div>
            <div class="mb-2">
                 <label class="text-danger fw-bold mb-1 small">แพ้ยา/อาหาร (ถ้าไม่มีขีด - )</label><input id="f6" class="form-control" value="${oldData?.allergy || '-'}">
            </div>
            
            <div id="parent-section" class="p-3 rounded bg-warning-subtle border border-warning mt-3">
                <label class="mb-1 fw-bold small">ผู้ปกครอง (สำหรับติดต่อฉุกเฉิน)</label>
                <input id="f8" class="form-control mb-2" placeholder="ชื่อ-นามสกุลผู้ปกครอง" value="${oldData?.parent || ''}">
                <input id="f9" class="form-control border-danger" placeholder="เบอร์โทรผู้ปกครอง (10 หลัก)" type="tel" maxlength="10" value="${oldData?.parentPhone || ''}">
            </div>
        </div>`,
        confirmButtonText: 'บันทึกข้อมูล', confirmButtonColor: '#6A1B9A',
        showCancelButton: true, cancelButtonText: 'ยกเลิก',
        
        // 2. เมื่อเปิด Popup ให้ตรวจสอบสถานะเริ่มต้น
        didOpen: () => {
            const lvl = document.getElementById('f_lvl');
            const pSec = document.getElementById('parent-section');
            const rBox = document.getElementById('room-box');
            
            // ฟังก์ชันซ่อน/แสดง ตามตัวเลือก
            const toggleFields = () => {
                const isAdult = ['ครู/บุคลากร', 'บุคคลทั่วไป'].includes(lvl.value);
                if(isAdult) {
                    pSec.style.display = 'none'; // ซ่อนช่องผู้ปกครอง
                    rBox.style.visibility = 'hidden'; // ซ่อนช่องห้อง
                } else {
                    pSec.style.display = 'block'; // แสดงช่องผู้ปกครอง
                    rBox.style.visibility = 'visible'; // แสดงช่องห้อง
                }
            };

            // เรียกทำงานทันทีและเมื่อมีการเปลี่ยนค่า
            lvl.addEventListener('change', toggleFields);
            toggleFields();
        },

        preConfirm: () => {
            const lvl = document.getElementById('f_lvl').value;
            const f2 = document.getElementById('f2').value.trim();
            const f4 = document.getElementById('f4').value.trim();
            let f8 = document.getElementById('f8').value.trim();
            let f9 = document.getElementById('f9').value.trim();
            let room = document.getElementById('f7').value;
            
            const bd_d = document.getElementById('bd_d').value;
            const phoneRegex = /^[0-9]{10}$/;
            const isAdult = ['ครู/บุคลากร', 'บุคคลทั่วไป'].includes(lvl);

            if(!f2) return Swal.showValidationMessage('กรุณากรอกชื่อ');
            if(!phoneRegex.test(f4)) return Swal.showValidationMessage('กรุณากรอกเบอร์โทรส่วนตัวให้ครบ 10 หลัก');
            if(!bd_d) return Swal.showValidationMessage('กรุณาเลือกวันเกิด');

            // 3. ตรวจสอบเงื่อนไข: ถ้าเป็นนักเรียน ต้องกรอกผู้ปกครอง / ถ้าเป็นผู้ใหญ่ ให้ข้ามได้
            if (!isAdult) {
                if(!f8 || !phoneRegex.test(f9)) return Swal.showValidationMessage('นักเรียนต้องกรอกข้อมูลผู้ปกครองและเบอร์โทรให้ครบถ้วน');
            } else {
                // ถ้าเป็นผู้ใหญ่ ให้ใส่ค่าขีดกลางอัตโนมัติ เพื่อไม่ให้ database error
                f8 = '-';
                f9 = '-';
                room = '-';
            }

            return {
                id: sid, prefix: document.getElementById('f1').value,
                fname: f2, lname: document.getElementById('f3').value.trim(),
                phone: f4, blood: document.getElementById('f5').value,
                allergy: document.getElementById('f6').value.trim(),
                level: lvl,
                room: room,
                parent: f8, parentPhone: f9, 
                dob: `${bd_d}/${document.getElementById('bd_m').value}/${document.getElementById('bd_y').value}`
            }
        }
    }).then(async (r) => {
        if(r.isConfirmed) {
            Swal.fire({didOpen:()=>Swal.showLoading(), allowOutsideClick: false});
            await setDoc(doc(db, "students", sid), r.value);
            window.checkStudent(); // รีโหลดเพื่อไปขั้นตอนยืนยัน
        }
    });
};

        window.confirmVisit = (sid, data) => {
    // --- 1. เรียกใช้ฟังก์ชันปิดบังเบอร์โทรศัพท์ ---
    const safePhone = maskPhone(data.phone);
    
    Swal.fire({
        title: 'ยืนยันข้อมูลเข้ารับบริการ',
        html: `<div class="p-3 border rounded text-start bg-light">
                <h5 class="text-primary fw-bold mb-2">${data.prefix}${data.fname} ${data.lname}</h5>
                <p class="mb-1 small"><b>เบอร์โทร:</b> ${safePhone}</p> <p class="mb-1 small"><b>ชั้น/ห้อง:</b> <span class="badge bg-secondary">${data.level} / ${data.room}</span></p>
                <p class="mb-0 small"><b>ประวัติการแพ้:</b> <span class="text-danger fw-bold">${data.allergy}</span></p>
               </div>`,
        showCancelButton: true, confirmButtonText: 'ยืนยันเข้ารับบริการ', confirmButtonColor: '#6A1B9A', cancelButtonText: 'ยกเลิก'
    }).then(async (r) => {
        if(r.isConfirmed) {
            Swal.fire({didOpen:()=>Swal.showLoading(), allowOutsideClick: false});
            await addDoc(collection(db, "visits"), {
                studentId: sid, studentName: `${data.prefix}${data.fname} ${data.lname}`,
                level: data.level, room: data.room, timestamp: serverTimestamp(), status: "Pending",
                category: "", detail: "", medicine: ""
            });
            Swal.fire('สำเร็จ', 'ส่งรายชื่อให้เจ้าหน้าที่แล้ว', 'success');
            document.getElementById('sid').value = '';
        }
    });
};
    </script>
</body>
</html>
