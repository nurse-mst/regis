<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin - Nurse MST</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        :root { --primary: #6A1B9A; --primary-hover: #4a148c; --secondary: #FFD600; --bg: #f8f9fa; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: #333; }
        
        /* Navbar */
        .navbar { background: linear-gradient(135deg, var(--primary), #8e24aa) !important; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .brand-icon { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        
        /* Cards & Tabs */
        .card { border-radius: 16px; border: none; box-shadow: 0 8px 24px rgba(106, 27, 154, 0.08); transition: transform 0.2s; }
        .nav-link { color: #666; font-weight: 500; border-radius: 30px !important; padding: 10px 20px; transition: 0.3s; cursor: pointer; }
        .nav-link.active { background-color: var(--primary) !important; color: white !important; box-shadow: 0 4px 10px rgba(106, 27, 154, 0.3); }
        .nav-link:hover:not(.active) { background-color: #e1bee7; color: var(--primary); }
        
        /* Custom Elements */
        .med-container { max-height: 150px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 12px; padding: 12px; background: #fff; }
        .btn-google { background: white; color: #444; border: 1px solid #ddd; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 30px; transition: 0.3s; }
        .btn-google:hover { background: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* Responsive Tweaks */
        @media (max-width: 768px) { .nav-link { font-size: 0.9rem; padding: 8px 12px; } }
    </style>
</head>
<body>

    <div id="loginArea" class="container min-vh-100 d-flex align-items-center justify-content-center">
        <div class="card p-5 text-center" style="max-width:400px; width:100%;">
            <img src="https://i.postimg.cc/gc78j2ZM/IMG-8784.png" width="100" class="mx-auto mb-4 brand-icon">
            <h4 class="fw-bold mb-2" style="color:var(--primary)">MSTSC Health Care <i class="fas fa-hospital-alt"></i></h4>
            <p class="text-muted small mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•<br>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</p>
            <button onclick="window.loginGoogle()" class="btn btn-google w-100 mb-3">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
            <div class="alert alert-info small border-0 bg-info-subtle text-info-emphasis">
                <i class="fas fa-lock me-1"></i> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
            </div>
        </div>
    </div>

    <div id="mainArea" style="display:none;">
        <nav class="navbar navbar-dark sticky-top px-3 py-2">
            <div class="container-fluid">
                <span class="navbar-brand fw-bold d-flex align-items-center gap-2">
                    <img src="https://i.postimg.cc/gc78j2ZM/IMG-8784.png" width="35" class="bg-white rounded-circle p-1">
                    <span>NURSE ADMIN <small class="opacity-75 fw-light" style="font-size:0.7em;">v3.1 (Safe Delete)</small></span>
                </span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-white small d-none d-md-block bg-white bg-opacity-10 px-3 py-1 rounded-pill" id="userEmail"><i class="fas fa-spinner fa-spin me-2"></i> Loading...</span>
                    <button class="btn btn-danger btn-sm rounded-circle shadow-sm" onclick="window.safeClearData()" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£/‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i class="fas fa-trash-alt"></i></button>
                    <button class="btn btn-warning btn-sm rounded-circle shadow-sm" onclick="window.location.reload()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä"><i class="fas fa-sync-alt"></i></button>
                    <button class="btn btn-light btn-sm rounded-pill px-3 fw-bold text-danger" onclick="window.logout()"><i class="fas fa-sign-out-alt me-1"></i> ‡∏≠‡∏≠‡∏Å</button>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <ul class="nav nav-pills mb-4 justify-content-center justify-content-md-start gap-2" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dash"><i class="fas fa-chart-pie me-2"></i>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#manage"><i class="fas fa-users-cog me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#imp"><i class="fas fa-file-import me-2"></i>Smart Import</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="dash">
                    <div class="row g-4">
                        <div class="col-lg-8">
                            <div class="card mb-4 border-start border-5 border-warning">
                                <div class="card-body">
                                    <h5 class="fw-bold text-warning mb-3"><i class="fas fa-user-clock me-2"></i>‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Real-time)</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <tbody id="pendingList">
                                                <tr><td class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="card border-start border-5 border-success">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                                    <h5 class="fw-bold text-success m-0"><i class="fas fa-clipboard-check me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h5>
                                    <div class="d-flex gap-2">
                                        <button onclick="window.openConfig()" class="btn btn-outline-primary btn-sm rounded-pill"><i class="fas fa-cog me-1"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                                        <button onclick="window.exportToCSV()" class="btn btn-success btn-sm rounded-pill"><i class="fas fa-file-excel me-1"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped mb-0 text-center align-middle">
                                            <thead class="table-success"><tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                            <tbody id="todayList"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card h-100 border-start border-5 border-primary">
                                <div class="card-header bg-white pt-3 pb-2">
                                    <h5 class="fw-bold text-primary mb-2"><i class="fas fa-chart-bar me-2"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h5>
                                    <input type="month" id="statMonthPicker" class="form-control form-control-sm border-primary" onchange="window.loadMonthlyStats()">
                                </div>
                                <div class="card-body">
                                    <div style="position: relative; height:250px;">
                                        <canvas id="statChart"></canvas>
                                    </div>
                                    <div class="mt-4 text-center">
                                        <div class="p-3 bg-light rounded-3">
                                            <h2 class="fw-bold text-dark m-0" id="totalCases">0</h2>
                                            <small class="text-muted" id="statLabel">‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="manage">
                    <div class="card">
                        <div class="card-header bg-white py-3">
                            <div class="row align-items-center">
                                <div class="col-md-6"><h5 class="fw-bold m-0 text-primary"><i class="fas fa-user-graduate me-2"></i>‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5></div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                        <input type="text" id="srch" class="form-control border-start-0 ps-0" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." onkeyup="filterStd()">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height:600px;">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light sticky-top"><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th class="text-center">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</th></tr></thead>
                                    <tbody id="allTable"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-white small text-muted">
                            <i class="fas fa-info-circle me-1"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="imp">
                    <div class="row justify-content-center">
                        <div class="col-md-9">
                            <div class="card border-0 shadow-lg">
                                <div class="card-body p-5 text-center">
                                    <div class="mb-4">
                                        <span class="display-4 text-primary"><i class="fas fa-file-import"></i></span>
                                    </div>
                                    <h4 class="fw-bold mb-3">Smart Import <i class="fas fa-robot text-secondary"></i></h4>
                                    
                                    <div class="bg-light p-3 rounded mb-4">
                                        <label class="fw-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:</label>
                                        <div class="d-flex justify-content-center gap-3">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="impMode" id="modeStd" value="std" checked onchange="updateHint()">
                                                <label class="form-check-label fw-bold" for="modeStd">üë®‚Äçüéì ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥)</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="impMode" id="modeHis" value="his" onchange="updateHint()">
                                                <label class="form-check-label fw-bold" for="modeHis">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤)</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="alert alert-info small text-start" id="hintBox"></div>
                                    
                                    <div class="form-floating mb-3">
                                        <textarea id="rawInput" class="form-control font-monospace" style="height: 250px; font-size: 0.9rem;" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"></textarea>
                                        <label>‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥) ‡∏´‡∏£‡∏∑‡∏≠ Text...</label>
                                    </div>
                                    
                                    <div class="d-flex gap-2 justify-content-center">
                                        <button class="btn btn-primary btn-lg rounded-pill px-5 shadow" onclick="processImport()">
                                            <i class="fas fa-magic me-2"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                                        </button>
                                        <button class="btn btn-outline-danger btn-lg rounded-pill px-4" onclick="window.clearOldSystemOnly()">
                                            <i class="fas fa-undo me-2"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (OldSystem)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, setDoc, getDoc, orderBy, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBY2n_f64ayN0Rlsq2x6-HT4NxmcePVCKA", 
            authDomain: "nurse-mstsc.firebaseapp.com",
            projectId: "nurse-mstsc",
            storageBucket: "nurse-mstsc.firebasestorage.app",
            messagingSenderId: "144915684733",
            appId: "1:144915684733:web:159a506c369c02410a4014"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let defaultCats = ["‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß/‡πÑ‡∏Ç‡πâ", "‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á", "‡∏ó‡∏≥‡πÅ‡∏ú‡∏•", "‡∏õ‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô", "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];
        let defaultMeds = ["‡∏û‡∏≤‡∏£‡∏≤‡πÄ‡∏ã‡∏ï‡∏≤‡∏°‡∏≠‡∏•", "‡∏¢‡∏≤‡∏ò‡∏≤‡∏ï‡∏∏‡∏ô‡πâ‡∏≥‡∏Ç‡∏≤‡∏ß", "‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÅ‡∏û‡πâ", "‡πÄ‡∏ö‡∏ï‡∏≤‡∏î‡∏µ‡∏ô", "‡∏û‡∏•‡∏≤‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡∏¢‡∏≤‡∏´‡∏≠‡∏°", "‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÅ‡∏£‡πà", "‡∏¢‡∏≤‡πÅ‡∏î‡∏á"];
        let allStudents = [];

        // AUTH
        onAuthStateChanged(auth, (user) => {
            const loginBox = document.getElementById('loginArea');
            const mainBox = document.getElementById('mainArea');
            if (user) {
                loginBox.classList.remove('d-flex'); loginBox.style.display = 'none';
                mainBox.style.display = 'block';
                document.getElementById('userEmail').innerHTML = `<i class="fas fa-user-circle me-2"></i>${user.email}`;
                const now = new Date(); document.getElementById('statMonthPicker').value = now.toISOString().slice(0, 7);
                initSystem();
            } else {
                loginBox.classList.add('d-flex'); loginBox.style.display = 'flex';
                mainBox.style.display = 'none';
            }
        });

        async function initSystem() {
            const configSnap = await getDoc(doc(db, "settings", "global"));
            if (configSnap.exists()) {
                const data = configSnap.data();
                if(data.categories) defaultCats = data.categories;
                if(data.medicines) defaultMeds = data.medicines;
            }
            startRealtimeListeners();
            window.updateHint(); // Init hint
            window.loadMonthlyStats();
        }

        window.loginGoogle = () => signInWithPopup(auth, provider).catch(e => Swal.fire('Error', e.message, 'error'));
        window.logout = () => signOut(auth).then(() => location.reload());

        function startRealtimeListeners() {
            // Queue
            onSnapshot(query(collection(db, "visits"), where("status", "==", "Pending"), orderBy("timestamp", "asc")), (snap) => {
                const html = snap.empty ? `<tr><td class="text-center text-muted py-4">‚ú® ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠</td></tr>` : 
                snap.docs.map(d => {
                    const v = d.data();
                    const time = v.timestamp ? new Date(v.timestamp.seconds*1000).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}) : '';
                    return `<tr class="table-warning"><td><span class="badge bg-white text-dark me-2">${time}</span> <b>${v.studentName}</b></td><td class="text-end"><button class="btn btn-primary btn-sm rounded-pill" onclick="window.treat('${d.id}', '${v.studentId}')">‡∏£‡∏±‡∏Å‡∏©‡∏≤</button></td></tr>`;
                }).join('');
                document.getElementById('pendingList').innerHTML = html;
            });

            // Today
            const today = new Date(); today.setHours(0,0,0,0);
            onSnapshot(query(collection(db, "visits"), where("status", "==", "Completed"), where("timestamp", ">=", today), orderBy("timestamp", "desc")), (snap) => {
                const html = snap.docs.map(d => {
                    const v = d.data();
                    return `<tr><td class="text-start text-primary fw-bold">${v.studentName}</td><td>${v.room}</td><td>${v.category}</td><td class="small text-muted">${v.medicine||'-'}</td><td><button class="btn btn-outline-secondary btn-sm rounded-circle" onclick="window.treat('${d.id}','${v.studentId}',true)"><i class="fas fa-pen"></i></button></td></tr>`;
                }).join('');
                document.getElementById('todayList').innerHTML = html || `<tr><td colspan="5" class="text-muted py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;
            });

            // Students
            onSnapshot(collection(db, "students"), (snap) => {
                allStudents = snap.docs.map(d => ({id: d.id, ...d.data()}));
                filterStd(); 
            });
        }

        // --- CORE FEATURES ---
        window.loadMonthlyStats = async () => {
            const picker = document.getElementById('statMonthPicker').value;
            if(!picker) return;
            const [year, month] = picker.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);
            
            document.getElementById('statLabel').innerText = `‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${month}/${year+543}`;
            const q = query(collection(db, "visits"), where("status", "==", "Completed"), where("timestamp", ">=", startDate), where("timestamp", "<=", endDate));
            const snap = await getDocs(q);
            document.getElementById('totalCases').innerText = snap.size;
            
            const counts = {};
            snap.docs.forEach(d => { const c = d.data().category || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'; counts[c] = (counts[c]||0)+1; });
            const ctx = document.getElementById('statChart');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { 
                type: 'doughnut', 
                data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40'] }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } 
            });
        };

        window.treat = async (visitId, studentId, isEdit = false) => {
            Swal.fire({didOpen:()=>Swal.showLoading()});
            const sSnap = await getDoc(doc(db, "students", studentId));
            const s = sSnap.exists() ? sSnap.data() : { allergy:'-', phone:'-', dob:'-', prefix:'', fname:'‡πÑ‡∏°‡πà‡∏û‡∏ö', lname:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' };
            const hSnap = await getDocs(query(collection(db, "visits"), where("studentId", "==", studentId), where("status", "==", "Completed"), orderBy("timestamp", "desc")));
            let hHtml = hSnap.docs.slice(0,5).map(d => `<li class="small text-muted">${d.data().category} (${d.data().medicine})</li>`).join('') || '-';
            Swal.close();

            const catOpts = defaultCats.map(c=>`<option>${c}</option>`).join('');
            const medChecks = defaultMeds.map(m=>`<div class="form-check"><input class="form-check-input mc" type="checkbox" value="${m}"><label class="form-check-label small">${m}</label></div>`).join('');

            await Swal.fire({
                title: isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏£‡∏±‡∏Å‡∏©‡∏≤', width: '600px',
                html: `
                <div class="text-start bg-light p-2 rounded mb-2 small">
                    <b>${s.prefix}${s.fname} ${s.lname}</b> (‡∏´‡πâ‡∏≠‡∏á ${s.room}) <span class="text-danger fw-bold">‡πÅ‡∏û‡πâ: ${s.allergy}</span>
                    <ul class="mb-0 ps-3">${hHtml}</ul>
                </div>
                <div class="text-start">
                    <label class="small fw-bold">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label><select id="s_cat" class="form-select mb-2">${catOpts}</select>
                    <label class="small fw-bold">‡∏¢‡∏≤</label><div class="med-container">${medChecks}</div>
                    <label class="small fw-bold mt-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label><input id="s_det" class="form-control form-control-sm">
                </div>`,
                preConfirm: () => ({
                    cat: document.getElementById('s_cat').value,
                    det: document.getElementById('s_det').value,
                    med: Array.from(document.querySelectorAll('.mc:checked')).map(e=>e.value).join(', ')
                })
            }).then(async (r) => {
                if(r.isConfirmed) {
                    const data = { category: r.value.cat, detail: r.value.det, medicine: r.value.med, status: 'Completed' };
                    if(!isEdit) data.timestamp = new Date();
                    await updateDoc(doc(db, "visits", visitId), data);
                    Swal.fire('Saved', '', 'success');
                    window.loadMonthlyStats();
                }
            });
        };

        window.openConfig = async () => {
            const { value: v } = await Swal.fire({
                title: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', html: `<input id="c1" class="form-control mb-2" value="${defaultCats}"><input id="c2" class="form-control" value="${defaultMeds}">`,
                preConfirm: () => ({ cats: document.getElementById('c1').value.split(','), meds: document.getElementById('c2').value.split(',') })
            });
            if(v) { await setDoc(doc(db, "settings", "global"), { categories: v.cats, medicines: v.meds }); Swal.fire('Saved','','success'); }
        };

        window.exportToCSV = async () => {
            const q = query(collection(db, "visits"), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            let csv = "\uFEFF‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤,‡∏£‡∏´‡∏±‡∏™,‡∏ä‡∏∑‡πà‡∏≠,‡∏≠‡∏≤‡∏Å‡∏≤‡∏£,‡∏¢‡∏≤\n";
            snap.forEach(d => {
                const v = d.data(); const dt = v.timestamp ? new Date(v.timestamp.seconds*1000) : new Date();
                csv += `${dt.toLocaleDateString('th-TH')},${dt.toLocaleTimeString('th-TH')},"${v.studentId}","${v.studentName}","${v.category}","${v.medicine}"\n`;
            });
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            link.download = `Report.csv`; link.click();
        };

        // --- SMART IMPORT V3 ---
        window.updateHint = () => {
            const mode = document.querySelector('input[name="impMode"]:checked').value;
            const hint = document.getElementById('hintBox');
            if(mode === 'std') hint.innerHTML = `‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: <code>‡∏£‡∏´‡∏±‡∏™ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</code> (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡πä‡∏≠‡∏õ‡∏à‡∏≤‡∏Å Excel)<br>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <code>30101 ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ</code> (‡∏£‡∏´‡∏±‡∏™‡∏ã‡πâ‡∏≥‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°)`;
            else hint.innerHTML = `‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: <code>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏´‡∏±‡∏™ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡∏¢‡∏≤</code><br>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <code>25/01/2569 09:00 30101 ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß ‡∏û‡∏≤‡∏£‡∏≤</code>`;
        };

        window.processImport = async () => {
            const mode = document.querySelector('input[name="impMode"]:checked').value;
            const lines = document.getElementById('rawInput').value.split('\n');
            const batch = writeBatch(db);
            let count = 0, skipped = 0;
            const existingIds = new Set(allStudents.map(s => s.id)); 

            for (const l of lines) {
                const cleanL = l.trim(); if(!cleanL) continue;
                let parts = cleanL.split('\t'); // Try TAB
                if (parts.length < 2) parts = cleanL.split(/\s+/); // Fallback Space

                if (mode === 'std') {
                    const idMatch = parts[0].match(/\d{5}/);
                    if (idMatch) {
                        const id = idMatch[0];
                        if (existingIds.has(id)) { skipped++; continue; }

                        let nameParts = parts.slice(1).join(' ').trim().split(' ');
                        let prefix='-', fname='-', lname='-';
                        if(nameParts.length >= 3) { prefix=nameParts[0]; fname=nameParts[1]; lname=nameParts.slice(2).join(' '); }
                        else if(nameParts.length == 2) { fname=nameParts[0]; lname=nameParts[1]; }
                        else if(nameParts.length == 1) { fname=nameParts[0]; }

                        batch.set(doc(db, "students", id), { id, prefix, fname, lname, room:'-', allergy:'-' });
                        existingIds.add(id); 
                        count++;
                    }
                } else {
                    if(parts.length >= 4) {
                        try {
                            const [d,m,y] = parts[0].split('/').map(Number);
                            const [hr,mn] = parts[1].split(':').map(Number);
                            const realY = y > 2400 ? y - 543 : y; 
                            const dateObj = new Date(realY, m-1, d, hr, mn);
                            
                            let name = parts[3];
                            let symptom = parts[4] || '-';
                            let meds = parts.slice(5).join(' ') || '-';

                            // Fix space separated names
                            if (!l.includes('\t') && parts.length > 5) {
                                name = parts[3] + ' ' + parts[4];
                                symptom = parts[5];
                                meds = parts.slice(6).join(' ');
                            }

                            batch.set(doc(collection(db, "visits")), {
                                studentId: parts[2],
                                studentName: name,
                                category: symptom,
                                medicine: meds,
                                status: 'Completed',
                                timestamp: dateObj,
                                room: 'OldSystem' // *** Key Identifier for safe delete ***
                            });
                            count++;
                        } catch(e) {}
                    }
                }
            }

            if(count > 0 || skipped > 0) {
                await batch.commit();
                Swal.fire('Success', `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£${skipped ? `<br>(‡∏Ç‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥ ${skipped})` : ''}`, 'success');
                document.getElementById('rawInput').value = '';
                window.loadMonthlyStats();
            } else {
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        };

        // --- NEW SAFE DELETE FUNCTIONS ---
        
        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OldSystem (‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Import)
        window.clearOldSystemOnly = async () => {
            const { isConfirmed } = await Swal.fire({
                title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤?',
                html: '‡∏à‡∏∞‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <b>"OldSystem"</b> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏µ‡∏¢‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö'
            });

            if (isConfirmed) {
                Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', didOpen:()=>Swal.showLoading()});
                const q = query(collection(db, "visits"), where("room", "==", "OldSystem"));
                const snap = await getDocs(q);
                const batch = writeBatch(db);
                let count = 0;
                snap.forEach(d => { batch.delete(d.ref); count++; });
                
                if(count > 0) {
                    await batch.commit();
                    Swal.fire('Deleted', `‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`, 'success');
                    window.loadMonthlyStats();
                } else {
                    Swal.fire('Info', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏ö', 'info');
                }
            }
        };

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô)
        window.safeClearData = async () => {
            const result = await Swal.fire({
                title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                html: `
                    <div class="text-start">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="delOld" checked>
                            <label class="form-check-label text-success fw-bold" for="delOld">‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà Import ‡∏°‡∏≤ (OldSystem) <span class="badge bg-success">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span></label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="delAllVisits">
                            <label class="form-check-label text-danger" for="delAllVisits">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="delStudents">
                            <label class="form-check-label" for="delStudents">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                preConfirm: () => ({
                    old: document.getElementById('delOld').checked,
                    allV: document.getElementById('delAllVisits').checked,
                    std: document.getElementById('delStudents').checked
                })
            });

            if (result.isConfirmed) {
                const { old, allV, std } = result.value;
                if (!old && !allV && !std) return;

                // Double confirm for dangerous actions
                if (allV || std) {
                    const confirm2 = await Swal.fire({
                        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á!',
                        text: '‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ã‡∏∂‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ',
                        icon: 'error',
                        showCancelButton: true,
                        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£'
                    });
                    if (!confirm2.isConfirmed) return;
                }

                Swal.fire({title:'Processing...', didOpen:()=>Swal.showLoading()});
                const batch = writeBatch(db);
                
                if (old) {
                    const q = await getDocs(query(collection(db, "visits"), where("room", "==", "OldSystem")));
                    q.forEach(d => batch.delete(d.ref));
                }
                if (allV) {
                    const q = await getDocs(collection(db, "visits"));
                    q.forEach(d => batch.delete(d.ref));
                }
                if (std) {
                    const q = await getDocs(collection(db, "students"));
                    q.forEach(d => batch.delete(d.ref));
                }

                await batch.commit();
                Swal.fire('Success', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                window.location.reload();
            }
        };

        window.filterStd = () => {
            const k = document.getElementById('srch').value;
            const list = allStudents.filter(s => s.id.includes(k) || (s.fname+' '+s.lname).includes(k));
            document.getElementById('allTable').innerHTML = list.slice(0,100).map(s => `<tr><td>${s.id}</td><td>${s.prefix}${s.fname} ${s.lname}</td><td>${s.room}</td><td class="text-center"><button class="btn btn-danger btn-sm rounded-pill" onclick="deleteDoc(doc(db,'students','${s.id}'))"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        };
    </script>
</body>
</html>
