<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin - Nurse MST</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        :root { --primary: #6A1B9A; --primary-hover: #4a148c; --secondary: #FFD600; --bg: #f8f9fa; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); color: #333; }
        
        /* Navbar */
        .navbar { background: linear-gradient(135deg, var(--primary), #8e24aa) !important; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .brand-icon { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        
        /* Cards & Tabs */
        .card { border-radius: 16px; border: none; box-shadow: 0 8px 24px rgba(106, 27, 154, 0.08); transition: transform 0.2s; }
        .nav-link { color: #666; font-weight: 500; border-radius: 30px !important; padding: 10px 20px; transition: 0.3s; cursor: pointer; }
        .nav-link.active { background-color: var(--primary) !important; color: white !important; box-shadow: 0 4px 10px rgba(106, 27, 154, 0.3); }
        .nav-link:hover:not(.active) { background-color: #e1bee7; color: var(--primary); }
        
        /* Custom Elements */
        .med-container { max-height: 150px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 12px; padding: 12px; background: #fff; }
        .btn-google { background: white; color: #444; border: 1px solid #ddd; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 30px; transition: 0.3s; }
        .btn-google:hover { background: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* Responsive Tweaks */
        @media (max-width: 768px) { .nav-link { font-size: 0.9rem; padding: 8px 12px; } }
    </style>
</head>
<body>

    <div id="loginArea" class="container min-vh-100 d-flex align-items-center justify-content-center">
        <div class="card p-5 text-center" style="max-width:400px; width:100%;">
            <img src="https://i.postimg.cc/gc78j2ZM/IMG-8784.png" width="100" class="mx-auto mb-4 brand-icon">
            <h4 class="fw-bold mb-2" style="color:var(--primary)">MST Health Care <i class="fas fa-hospital-alt"></i></h4>
            <p class="text-muted small mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•<br>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</p>
            <button onclick="window.loginGoogle()" class="btn btn-google w-100 mb-3">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
            <div class="alert alert-info small border-0 bg-info-subtle text-info-emphasis">
                <i class="fas fa-lock me-1"></i> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
            </div>
        </div>
    </div>

    <div id="mainArea" style="display:none;">
        <nav class="navbar navbar-dark sticky-top px-3 py-2">
            <div class="container-fluid">
                <span class="navbar-brand fw-bold d-flex align-items-center gap-2">
                    <img src="https://i.postimg.cc/gc78j2ZM/IMG-8784.png" width="35" class="bg-white rounded-circle p-1">
                    <span>NURSE ADMIN <small class="opacity-75 fw-light" style="font-size:0.7em;">v3.0 (Stats & Anti-Dupe)</small></span>
                </span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-white small d-none d-md-block bg-white bg-opacity-10 px-3 py-1 rounded-pill" id="userEmail"><i class="fas fa-spinner fa-spin me-2"></i> Loading...</span>
                    <button class="btn btn-danger btn-sm rounded-circle shadow-sm" onclick="window.clearData()" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö"><i class="fas fa-trash-alt"></i></button>
                    <button class="btn btn-warning btn-sm rounded-circle shadow-sm" onclick="window.location.reload()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä"><i class="fas fa-sync-alt"></i></button>
                    <button class="btn btn-light btn-sm rounded-pill px-3 fw-bold text-danger" onclick="window.logout()"><i class="fas fa-sign-out-alt me-1"></i> ‡∏≠‡∏≠‡∏Å</button>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <ul class="nav nav-pills mb-4 justify-content-center justify-content-md-start gap-2" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dash"><i class="fas fa-chart-pie me-2"></i>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#manage"><i class="fas fa-users-cog me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#imp"><i class="fas fa-file-import me-2"></i>Smart Import</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="dash">
                    <div class="row g-4">
                        <div class="col-lg-8">
                            <div class="card mb-4 border-start border-5 border-warning">
                                <div class="card-body">
                                    <h5 class="fw-bold text-warning mb-3"><i class="fas fa-user-clock me-2"></i>‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Real-time)</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <tbody id="pendingList">
                                                <tr><td class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="card border-start border-5 border-success">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                                    <h5 class="fw-bold text-success m-0"><i class="fas fa-clipboard-check me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h5>
                                    <div class="d-flex gap-2">
                                        <button onclick="window.openConfig()" class="btn btn-outline-primary btn-sm rounded-pill"><i class="fas fa-cog me-1"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                                        <button onclick="window.exportToCSV()" class="btn btn-success btn-sm rounded-pill"><i class="fas fa-file-excel me-1"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped mb-0 text-center align-middle">
                                            <thead class="table-success"><tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                            <tbody id="todayList"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card h-100 border-start border-5 border-primary">
                                <div class="card-header bg-white pt-3 pb-2">
                                    <h5 class="fw-bold text-primary mb-2"><i class="fas fa-chart-bar me-2"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h5>
                                    <input type="month" id="statMonthPicker" class="form-control form-control-sm border-primary" onchange="window.loadMonthlyStats()">
                                </div>
                                <div class="card-body">
                                    <div style="position: relative; height:250px;">
                                        <canvas id="statChart"></canvas>
                                    </div>
                                    <div class="mt-4 text-center">
                                        <div class="p-3 bg-light rounded-3">
                                            <h2 class="fw-bold text-dark m-0" id="totalCases">0</h2>
                                            <small class="text-muted" id="statLabel">‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="manage">
                    <div class="card">
                        <div class="card-header bg-white py-3">
                            <div class="row align-items-center">
                                <div class="col-md-6"><h5 class="fw-bold m-0 text-primary"><i class="fas fa-user-graduate me-2"></i>‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5></div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                        <input type="text" id="srch" class="form-control border-start-0 ps-0" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." onkeyup="filterStd()">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height:600px;">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light sticky-top"><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th class="text-center">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</th></tr></thead>
                                    <tbody id="allTable"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-white small text-muted">
                            <i class="fas fa-info-circle me-1"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="imp">
                    <div class="row justify-content-center">
                        <div class="col-md-9">
                            <div class="card border-0 shadow-lg">
                                <div class="card-body p-5 text-center">
                                    <div class="mb-4">
                                        <span class="display-4 text-primary"><i class="fas fa-file-import"></i></span>
                                    </div>
                                    <h4 class="fw-bold mb-3">Smart Import <i class="fas fa-robot text-secondary"></i></h4>
                                    
                                    <div class="bg-light p-3 rounded mb-4">
                                        <label class="fw-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:</label>
                                        <div class="d-flex justify-content-center gap-3">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="impMode" id="modeStd" value="std" checked onchange="updateHint()">
                                                <label class="form-check-label fw-bold" for="modeStd">üë®‚Äçüéì ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥)</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="impMode" id="modeHis" value="his" onchange="updateHint()">
                                                <label class="form-check-label fw-bold" for="modeHis">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤)</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="alert alert-info small text-start" id="hintBox">
                                        <i class="fas fa-info-circle"></i> <b>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:</b> <code>‡∏£‡∏´‡∏±‡∏™ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</code> ‡∏´‡∏£‡∏∑‡∏≠ <code>‡∏£‡∏´‡∏±‡∏™ ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</code><br>
                                        ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <code>30101 ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ</code> (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ ‡∏£‡∏´‡∏±‡∏™ 30101 ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°)
                                    </div>
                                    
                                    <div class="form-floating mb-3">
                                        <textarea id="rawInput" class="form-control font-monospace" style="height: 250px; font-size: 0.9rem;" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"></textarea>
                                        <label>‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel ‡∏´‡∏£‡∏∑‡∏≠ Text ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</label>
                                    </div>
                                    
                                    <button class="btn btn-primary btn-lg rounded-pill px-5 shadow" onclick="processImport()">
                                        <i class="fas fa-magic me-2"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, setDoc, getDoc, orderBy, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ‡πÉ‡∏™‡πà Firebase Config ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ---
        const firebaseConfig = {
            apiKey: "AIzaSyBY2n_f64ayN0Rlsq2x6-HT4NxmcePVCKA", 
            authDomain: "nurse-mstsc.firebaseapp.com",
            projectId: "nurse-mstsc",
            storageBucket: "nurse-mstsc.firebasestorage.app",
            messagingSenderId: "144915684733",
            appId: "1:144915684733:web:159a506c369c02410a4014"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let defaultCats = ["‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß/‡πÑ‡∏Ç‡πâ", "‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á", "‡∏ó‡∏≥‡πÅ‡∏ú‡∏•", "‡∏õ‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô", "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];
        let defaultMeds = ["‡∏û‡∏≤‡∏£‡∏≤‡πÄ‡∏ã‡∏ï‡∏≤‡∏°‡∏≠‡∏•", "‡∏¢‡∏≤‡∏ò‡∏≤‡∏ï‡∏∏‡∏ô‡πâ‡∏≥‡∏Ç‡∏≤‡∏ß", "‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÅ‡∏û‡πâ", "‡πÄ‡∏ö‡∏ï‡∏≤‡∏î‡∏µ‡∏ô", "‡∏û‡∏•‡∏≤‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡∏¢‡∏≤‡∏´‡∏≠‡∏°", "‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÅ‡∏£‡πà", "‡∏¢‡∏≤‡πÅ‡∏î‡∏á"];
        let allStudents = [];

        // --- Auth & View Logic ---
        onAuthStateChanged(auth, (user) => {
            const loginBox = document.getElementById('loginArea');
            const mainBox = document.getElementById('mainArea');

            if (user) {
                loginBox.classList.remove('d-flex');
                loginBox.style.display = 'none';
                mainBox.style.display = 'block';
                document.getElementById('userEmail').innerHTML = `<i class="fas fa-user-circle me-2"></i>${user.email}`;
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ Picker
                const now = new Date();
                const currentMonth = now.toISOString().slice(0, 7); // YYYY-MM
                document.getElementById('statMonthPicker').value = currentMonth;

                initSystem();
            } else {
                loginBox.classList.add('d-flex');
                loginBox.style.display = 'flex';
                mainBox.style.display = 'none';
            }
        });

        async function initSystem() {
            const configSnap = await getDoc(doc(db, "settings", "global"));
            if (configSnap.exists()) {
                const data = configSnap.data();
                if(data.categories) defaultCats = data.categories;
                if(data.medicines) defaultMeds = data.medicines;
            }
            startRealtimeListeners();
            window.loadMonthlyStats(); // Load stats for current month
        }

        window.loginGoogle = () => signInWithPopup(auth, provider).catch(e => Swal.fire('Login Error', e.message, 'error'));
        window.logout = () => signOut(auth).then(() => location.reload());

        function startRealtimeListeners() {
            // 1. Pending Queue (Real-time)
            const qPending = query(collection(db, "visits"), where("status", "==", "Pending"), orderBy("timestamp", "asc"));
            onSnapshot(qPending, (snap) => {
                const html = snap.empty ? `<tr><td class="text-center text-muted py-4"><i class="fas fa-check-circle text-success me-2"></i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</td></tr>` : 
                snap.docs.map(d => {
                    const v = d.data();
                    const time = v.timestamp ? new Date(v.timestamp.seconds*1000).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}) : '';
                    return `<tr class="table-warning">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-white p-2 rounded-circle me-3 shadow-sm text-warning fw-bold">${time}</div>
                                <div><h6 class="mb-0 fw-bold">${v.studentName}</h6><small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>‡∏´‡πâ‡∏≠‡∏á: ${v.room}</small></div>
                            </div>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-primary rounded-pill shadow-sm px-3" onclick="window.treat('${d.id}', '${v.studentId}')"><i class="fas fa-stethoscope me-1"></i> ‡∏£‡∏±‡∏Å‡∏©‡∏≤</button>
                        </td>
                    </tr>`;
                }).join('');
                document.getElementById('pendingList').innerHTML = html;
            });

            // 2. Today List (Real-time) - ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô Real-time
            const today = new Date(); today.setHours(0,0,0,0);
            const qToday = query(collection(db, "visits"), where("status", "==", "Completed"), where("timestamp", ">=", today), orderBy("timestamp", "desc"));
            onSnapshot(qToday, (snap) => {
                const html = snap.docs.map(d => {
                    const v = d.data();
                    return `<tr>
                        <td class="text-start fw-bold text-primary">${v.studentName}</td>
                        <td><span class="badge bg-light text-dark border">${v.room}</span></td>
                        <td><span class="badge bg-warning text-dark">${v.category}</span></td>
                        <td class="small text-muted">${v.medicine || '-'}</td>
                        <td><button class="btn btn-outline-secondary btn-sm rounded-circle" onclick="window.treat('${d.id}', '${v.studentId}', true)"><i class="fas fa-pen"></i></button></td>
                    </tr>`;
                }).join('');
                document.getElementById('todayList').innerHTML = html || `<tr><td colspan="5" class="text-muted py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;
            });

            // 3. Students List
            onSnapshot(collection(db, "students"), (snap) => {
                allStudents = snap.docs.map(d => ({id: d.id, ...d.data()}));
                filterStd(); 
            });
        }

        // --- NEW: Monthly Statistics ---
        window.loadMonthlyStats = async () => {
            const picker = document.getElementById('statMonthPicker').value; // YYYY-MM
            if(!picker) return;

            const [year, month] = picker.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);

            // Update Label
            const monthNames = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
            document.getElementById('statLabel').innerText = `‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNames[month-1]} ${year+543}`;

            // Query Firestore
            const q = query(collection(db, "visits"), 
                where("status", "==", "Completed"), 
                where("timestamp", ">=", startDate), 
                where("timestamp", "<=", endDate)
            );

            const snap = await getDocs(q);
            document.getElementById('totalCases').innerText = snap.size;
            updateStatsChart(snap.docs);
        };

        function updateStatsChart(docs) {
            const counts = {};
            docs.forEach(d => { const c = d.data().category || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; counts[c] = (counts[c]||0)+1; });
            const ctx = document.getElementById('statChart');
            
            if(window.myChart) window.myChart.destroy();
            
            window.myChart = new Chart(ctx, { 
                type: 'doughnut', 
                data: { 
                    labels: Object.keys(counts), 
                    datasets: [{ 
                        data: Object.values(counts), 
                        backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#C9CBCF'] 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } } 
                } 
            });
        }

        // --- Treat & Edit Logic ---
        window.treat = async (visitId, studentId, isEdit = false) => {
            Swal.fire({title:'<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', didOpen:()=>Swal.showLoading()});
            
            const sSnap = await getDoc(doc(db, "students", studentId));
            const s = sSnap.exists() ? sSnap.data() : { allergy:'-', phone:'-', dob:'-', prefix:'', fname:'‡πÑ‡∏°‡πà‡∏û‡∏ö', lname:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' };
            
            const hQ = query(collection(db, "visits"), where("studentId", "==", studentId), where("status", "==", "Completed"), orderBy("timestamp", "desc"));
            const hSnap = await getDocs(hQ);
            let historyHtml = hSnap.docs.slice(0,5).map(d => {
                const v = d.data();
                const date = v.timestamp ? new Date(v.timestamp.seconds*1000).toLocaleDateString('th-TH') : '-';
                return `<li class="list-group-item small border-0 border-bottom">
                    <div class="d-flex justify-content-between fw-bold"><span>${v.category}</span><span class="text-muted">${date}</span></div>
                    <div class="text-muted fst-italic">${v.medicine}</div>
                </li>`;
            }).join('') || '<div class="text-center text-muted p-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡πà‡∏≤</div>';

            Swal.close();

            const catOpts = defaultCats.map(c=>`<option>${c}</option>`).join('');
            const medChecks = defaultMeds.map(m=>`<div class="form-check"><input class="form-check-input mc" type="checkbox" value="${m}" id="m_${m.replace(/\s/g,'')}"><label class="form-check-label small" for="m_${m.replace(/\s/g,'')}">${m}</label></div>`).join('');

            await Swal.fire({
                title: isEdit ? '<i class="fas fa-edit me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '<i class="fas fa-user-md me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤',
                width: '900px',
                html: `
                <div class="row text-start">
                    <div class="col-lg-6 border-end">
                        <div class="bg-light p-3 rounded mb-3">
                            <h6 class="fw-bold text-primary mb-2"><i class="fas fa-user-circle me-1"></i> ${s.prefix}${s.fname} ${s.lname}</h6>
                            <div class="row g-2 small">
                                <div class="col-6"><label class="text-muted">‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</label> <input id="e_al" class="form-control form-control-sm text-danger fw-bold" value="${s.allergy}"></div>
                                <div class="col-6"><label class="text-muted">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</label> <input id="e_ph" class="form-control form-control-sm" value="${s.phone}"></div>
                                <div class="col-12"><label class="text-muted">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</label> <input id="e_dob" class="form-control form-control-sm" value="${s.dob}"></div>
                            </div>
                        </div>
                        <h6 class="text-secondary small fw-bold"><i class="fas fa-history me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</h6>
                        <ul class="list-group list-group-flush" style="max-height:150px; overflow-y:auto;">${historyHtml}</ul>
                    </div>
                    <div class="col-lg-6 ps-lg-4">
                        <h6 class="fw-bold text-warning mb-3"><i class="fas fa-file-medical-alt me-1"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h6>
                        <div class="mb-3">
                            <label class="small fw-bold">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å</label>
                            <select id="s_cat" class="form-select">${catOpts}</select>
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                            <textarea id="s_det" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold">‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß)</label>
                            <div class="med-container">${medChecks}</div>
                        </div>
                    </div>
                </div>`,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                confirmButtonColor: '#6A1B9A',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    return {
                        sUpdate: { allergy: document.getElementById('e_al').value, phone: document.getElementById('e_ph').value, dob: document.getElementById('e_dob').value },
                        vUpdate: { 
                            category: document.getElementById('s_cat').value, 
                            detail: document.getElementById('s_det').value,
                            medicine: Array.from(document.querySelectorAll('.mc:checked')).map(e=>e.value).join(', '), 
                            status: 'Completed',
                            timestamp: isEdit ? undefined : new Date()
                        }
                    }
                }
            }).then(async (r) => {
                if(r.isConfirmed) {
                    const batch = writeBatch(db);
                    if(sSnap.exists()) batch.update(doc(db, "students", studentId), r.value.sUpdate);
                    const vData = r.value.vUpdate;
                    if(isEdit) delete vData.timestamp;
                    batch.update(doc(db, "visits", visitId), vData);
                    await batch.commit();
                    Swal.fire({icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer:1500, showConfirmButton:false});
                    window.loadMonthlyStats(); // Update stats if month matches
                }
            });
        };

        window.openConfig = async () => {
            const { value: formValues } = await Swal.fire({
                title: '<i class="fas fa-cogs"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö',
                html: `
                <div class="text-start">
                    <label class="small fw-bold mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)</label>
                    <textarea id="cfg_cats" class="form-control mb-3" rows="3">${defaultCats.join(', ')}</textarea>
                    <label class="small fw-bold mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)</label>
                    <textarea id="cfg_meds" class="form-control" rows="3">${defaultMeds.join(', ')}</textarea>
                </div>
                `,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤',
                preConfirm: () => {
                    return {
                        categories: document.getElementById('cfg_cats').value.split(',').map(s=>s.trim()).filter(s=>s),
                        medicines: document.getElementById('cfg_meds').value.split(',').map(s=>s.trim()).filter(s=>s)
                    }
                }
            });

            if (formValues) {
                await setDoc(doc(db, "settings", "global"), formValues);
                defaultCats = formValues.categories;
                defaultMeds = formValues.medicines;
                Swal.fire('Updated', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        };

        window.exportToCSV = async () => {
            Swal.fire({title:'<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå...', didOpen:()=>Swal.showLoading()});
            const q = query(collection(db, "visits"), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            
            let csv = "\uFEFF‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•,‡∏´‡πâ‡∏≠‡∏á,‡∏≠‡∏≤‡∏Å‡∏≤‡∏£,‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î,‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢\n";
            snap.forEach(d => {
                const v = d.data();
                const date = v.timestamp ? new Date(v.timestamp.seconds*1000) : new Date();
                const clean = t => `"${(t||'').replace(/"/g,'""')}"`;
                csv += `${date.toLocaleDateString('th-TH')},${date.toLocaleTimeString('th-TH')},${clean(v.studentId)},${clean(v.studentName)},${clean(v.room)},${clean(v.category)},${clean(v.detail)},${clean(v.medicine)}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `HealthReport_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            Swal.close();
        };

        window.filterStd = () => {
            const k = document.getElementById('srch').value;
            const list = allStudents.filter(s => s.id.includes(k) || (s.fname+' '+s.lname).includes(k));
            renderStudents(list.slice(0, 100)); 
        };

        function renderStudents(list) {
            const html = list.map(s => `
                <tr>
                    <td class="fw-bold text-primary">${s.id}</td>
                    <td>${s.prefix}${s.fname} ${s.lname}</td>
                    <td><span class="badge bg-light text-dark border">${s.room}</span></td>
                    <td class="text-center">
                        <button onclick="window.viewStudent('${s.id}')" class="btn btn-info btn-sm text-white rounded-pill me-1" title="‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å"><i class="fas fa-eye"></i></button>
                        <button onclick="window.editStudent('${s.id}')" class="btn btn-warning btn-sm text-white rounded-pill me-1" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fas fa-edit"></i></button>
                        <button onclick="window.delStudent('${s.id}')" class="btn btn-danger btn-sm rounded-pill" title="‡∏•‡∏ö"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('allTable').innerHTML = html;
        }

        window.viewStudent = async (sid) => {
            Swal.fire({title:'<i class="fas fa-spinner fa-spin"></i> Loading Profile...', didOpen:()=>Swal.showLoading()});
            const s = allStudents.find(x => x.id === sid);
            
            const hQ = query(collection(db, "visits"), where("studentId", "==", sid), orderBy("timestamp", "desc"));
            const hSnap = await getDocs(hQ);
            const historyList = hSnap.docs.map(d => {
                const v = d.data();
                const date = v.timestamp ? new Date(v.timestamp.seconds*1000).toLocaleDateString('th-TH') : '-';
                return `<tr><td>${date}</td><td><span class="badge bg-secondary">${v.category}</span></td><td>${v.medicine||'-'}</td></tr>`;
            }).join('');

            Swal.fire({
                title: `<i class="fas fa-id-card"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${s.fname} ${s.lname}`,
                width: '800px',
                html: `
                <div class="row text-start">
                    <div class="col-md-5">
                        <div class="card bg-light border-0 mb-3">
                            <div class="card-body">
                                <p class="mb-1"><strong>‡∏£‡∏´‡∏±‡∏™:</strong> ${s.id}</p>
                                <p class="mb-1"><strong>‡∏´‡πâ‡∏≠‡∏á:</strong> ${s.room}</p>
                                <p class="mb-1"><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${s.phone}</p>
                                <p class="mb-1 text-danger"><strong>‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</strong> ${s.allergy}</p>
                                <p class="mb-1"><strong>‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á:</strong> ${s.parent} (${s.parentPhone})</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <h6 class="fw-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${hSnap.size} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</h6>
                        <div class="table-responsive" style="max-height:250px;">
                            <table class="table table-sm table-striped small">
                                <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≤</th></tr></thead>
                                <tbody>${historyList}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
                `
            });
        };

        window.editStudent = (sid) => {
            const s = allStudents.find(x => x.id === sid);
            Swal.fire({
                title: '<i class="fas fa-user-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                html: `
                <div class="row g-2 text-start">
                    <div class="col-4"><label class="small">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label><input id="ed_pf" class="form-control form-control-sm" value="${s.prefix}"></div>
                    <div class="col-4"><label class="small">‡∏ä‡∏∑‡πà‡∏≠</label><input id="ed_fn" class="form-control form-control-sm" value="${s.fname}"></div>
                    <div class="col-4"><label class="small">‡∏™‡∏Å‡∏∏‡∏•</label><input id="ed_ln" class="form-control form-control-sm" value="${s.lname}"></div>
                    <div class="col-6"><label class="small">‡∏´‡πâ‡∏≠‡∏á</label><input id="ed_rm" class="form-control form-control-sm" value="${s.room}"></div>
                    <div class="col-6"><label class="small">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input id="ed_ph" class="form-control form-control-sm" value="${s.phone}"></div>
                    <div class="col-12"><label class="small text-danger fw-bold">‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input id="ed_al" class="form-control form-control-sm" value="${s.allergy}"></div>
                    <div class="col-6"><label class="small">‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><input id="ed_pa" class="form-control form-control-sm" value="${s.parent}"></div>
                    <div class="col-6"><label class="small">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><input id="ed_pp" class="form-control form-control-sm" value="${s.parentPhone}"></div>
                </div>`,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                preConfirm: () => {
                    return {
                        prefix: document.getElementById('ed_pf').value,
                        fname: document.getElementById('ed_fn').value,
                        lname: document.getElementById('ed_ln').value,
                        room: document.getElementById('ed_rm').value,
                        phone: document.getElementById('ed_ph').value,
                        allergy: document.getElementById('ed_al').value,
                        parent: document.getElementById('ed_pa').value,
                        parentPhone: document.getElementById('ed_pp').value,
                    }
                }
            }).then(async (r) => {
                if(r.isConfirmed) {
                    await updateDoc(doc(db, "students", sid), r.value);
                    Swal.fire('Saved', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            });
        };

        window.delStudent = async (sid) => {
            if((await Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?', text:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'})).isConfirmed) {
                await deleteDoc(doc(db, "students", sid));
                Swal.fire('Deleted', '', 'success');
            }
        };

        // --- Helper: Update Hint Text ---
        window.updateHint = () => {
            const mode = document.querySelector('input[name="impMode"]:checked').value;
            const hintBox = document.getElementById('hintBox');
            if(mode === 'std') {
                hintBox.innerHTML = `<i class="fas fa-info-circle"></i> <b>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:</b> <code>‡∏£‡∏´‡∏±‡∏™ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</code> ‡∏´‡∏£‡∏∑‡∏≠ <code>‡∏£‡∏´‡∏±‡∏™ ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</code><br>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <code>30101 ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ</code> (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ã‡πâ‡∏≥)`;
            } else {
                hintBox.innerHTML = `<i class="fas fa-info-circle"></i> <b>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:</b> <code>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏´‡∏±‡∏™ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡∏¢‡∏≤</code> (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ)<br>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <code>25/01/2567 08:30 30101 ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß ‡∏û‡∏≤‡∏£‡∏≤</code>`;
            }
        };

        // --- NEW: Smart Import V2 (Anti-Duplicate & History) ---
        window.processImport = async () => {
            const mode = document.querySelector('input[name="impMode"]:checked').value;
            const lines = document.getElementById('rawInput').value.split('\n');
            const batch = writeBatch(db);
            let count = 0;
            let skipped = 0;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Set ‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å)
            const existingIds = new Set(allStudents.map(s => s.id));

            if (mode === 'std') {
                // --- IMPORT STUDENT LIST ---
                lines.forEach(l => {
                    const cleanL = l.trim();
                    if(!cleanL) return;
                    
                    const idMatch = cleanL.match(/\b\d{5}\b/);
                    if(idMatch) {
                        const id = idMatch[0];
                        
                        // *** Anti-Duplicate Check ***
                        if (existingIds.has(id)) {
                            skipped++;
                            return; // Skip this iteration
                        }

                        const parts = cleanL.replace(id, '').trim().split(/\s+/);
                        let prefix = '-', fname = '-', lname = '-';
                        if(parts.length >= 3) { prefix = parts[0]; fname = parts[1]; lname = parts[2]; } 
                        else if(parts.length == 2) { fname = parts[0]; lname = parts[1]; } 
                        else if(parts.length == 1) { fname = parts[0]; }

                        const ref = doc(db, "students", id);
                        batch.set(ref, { 
                            id, prefix, fname, lname, 
                            room:'-', allergy:'-', phone:'-', dob:'-', parent:'-', parentPhone:'-' 
                        });
                        count++;
                    }
                });

            } else {
                // --- IMPORT HISTORY ---
                lines.forEach(l => {
                    const cleanL = l.trim();
                    if(!cleanL) return;
                    const parts = cleanL.split(/\s+/);
                    if(parts.length >= 5) {
                        try {
                            const [day, month, year] = parts[0].split('/').map(Number);
                            const [hour, min] = parts[1].split(':').map(Number);
                            const finalYear = year > 2400 ? year - 543 : year;
                            const dateObj = new Date(finalYear, month - 1, day, hour, min);

                            if(isNaN(dateObj.getTime())) return; 

                            const ref = doc(collection(db, "visits"));
                            batch.set(ref, {
                                studentId: parts[2],
                                studentName: parts[3],
                                category: parts[4],
                                medicine: parts.slice(5).join(' ') || '-',
                                room: 'OldSystem',
                                detail: 'Imported Data',
                                status: 'Completed',
                                timestamp: dateObj
                            });
                            count++;
                        } catch(e) {}
                    }
                });
            }

            if(count > 0 || skipped > 0) {
                await batch.commit();
                let msg = `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                if(skipped > 0) msg += `<br><span class="text-danger">‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ ${skipped} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>`;
                
                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                    html: msg
                });
                document.getElementById('rawInput').value = '';
                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                window.loadMonthlyStats();
            } else {
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'error');
            }
        };

        // --- CLEAR DATA FUNCTION ---
        window.clearData = async () => {
            const result = await Swal.fire({
                title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö?',
                html: `
                    <div class="text-danger mb-3"><i class="fas fa-exclamation-triangle fa-3x"></i></div>
                    <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏´‡∏ô?</p>
                    <div class="form-check text-start d-inline-block">
                        <input class="form-check-input" type="checkbox" id="delVisits" checked>
                        <label class="form-check-label" for="delVisits">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                    </div><br>
                    <div class="form-check text-start d-inline-block">
                        <input class="form-check-input" type="checkbox" id="delStudents">
                        <label class="form-check-label" for="delStudents">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => ({
                    visits: document.getElementById('delVisits').checked,
                    students: document.getElementById('delStudents').checked
                })
            });

            if (result.isConfirmed) {
                Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', didOpen:()=>Swal.showLoading()});
                const batch = writeBatch(db);
                let count = 0;

                if (result.value.visits) {
                    const q = await getDocs(collection(db, "visits"));
                    q.forEach(d => { batch.delete(d.ref); count++; });
                }
                
                if (result.value.students) {
                    const q = await getDocs(collection(db, "students"));
                    q.forEach(d => { batch.delete(d.ref); count++; });
                }

                if(count > 0) {
                    await batch.commit();
                    Swal.fire('Deleted', `‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${count} records)`, 'success');
                    allStudents = []; 
                    document.getElementById('todayList').innerHTML = '';
                    document.getElementById('allTable').innerHTML = '';
                    window.loadMonthlyStats();
                } else {
                    Swal.fire('Info', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏ö', 'info');
                }
            }
        };

    </script>
</body>
</html>